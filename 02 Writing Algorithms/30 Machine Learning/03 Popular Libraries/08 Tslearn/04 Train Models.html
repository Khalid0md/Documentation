<p>In this example, a time-series clustering model will be trained. Instead of using real-time comparison, we could apply a technique call Dynamic Time Wrapping (DTW) with Barycenter Averaging (DBA). Intuitively, it is a technique of averaging a few time-series into a single one without losing much of their information. Since not all time-series would move efficiently like in ideal EMH assumption, this would allow similarity analysis of different time-series with sticky lags. Check the technical details from <a href="https://tslearn.readthedocs.io/en/stable/user_guide/dtw.html">tslearn documentation page</a>.</p>

<img class="docs-image" src="https://cdn.quantconnect.com/i/tu/dba.png">

<p>We then can separate different clusters by KMean after DBA. Follow these steps to create a method to train your model:</p>

<h4>History Call</h4>
<p>You need historical data to train the model. Call <code>History</code> with list of <code>Symbol</code>, timerule, and resolution to obtain historical data. In this example, 2 years of daily trade bar data is used.</p>
<div class="section-example-container">
    <pre class="python">self.History(symbols, 252*2, Resolution.Daily)</pre>
</div>

<h4>Prepare Data</h4>
<p>Follow the below steps to create a method to prepare the data for training and prediction.</p>
<ol>
    <li>Unstack the historical DataFrame and select the close column.</li>
    <div class="section-example-container">
        <pre class="python">close = history.unstack(0).close</pre>
    </div>

    <li>Take the logarithm of the historical time series.</li>
    <div class="section-example-container">
        <pre class="python">log_close = np.log(close)</pre>
    </div>
    <p>Taking the logarithm eases the compounding effect.</p>

    <li>Standardize the data.</li>
    <div class="section-example-container">
        <pre class="python">standard_close = (log_close - log_close.mean()) / log_close.std()</pre>
    </div>
</ol>

<h4>Build and Fit Model</h4>
<p>Follow the below steps to build and fit the model.</p>
<ol>
    <li>Call the <code>TimeSeriesKMeans</code> constructor with a preset number of clusters, choice of distance measurement.</li>
    <div class="section-example-container">
        <pre class="python">self.model = TimeSeriesKMeans(n_clusters=6,   # We have 6 main groups
                      metric="dtw")</pre>
    </div>
    
    <li>Call the <code>fit</code> method with the transformed historical data.</li>
    <div class="section-example-container">
        <pre class="python">self.model.fit(standard_close.T)</pre>
    </div>
</ol>